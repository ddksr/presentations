<!DOCTYPE html>
<html>
  <head>
    <title>Real-world end-to-end testing of Angular apps</title>
    <meta charset="utf-8">
	<link href="../p.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
      <textarea id="source">

class: center, middle

# Real-world end-to-end testing of Angular apps

Žiga Stopinšek - ziga.stopinsek@zemanta.com

---

# Agenda

.agenda[
1. E2E testing
1. Protractor
1. Complementary tools
1. Case study =)
1. DEMO
]

---

# E2E testing

*Techopedia*: <q cite="https://www.techopedia.com/definition/7035/end-to-end-test">End-to-end testing is a methodology used to test whether the flow of an application is performing as designed from start to finish. The purpose of carrying out end-to-end tests is to identify system dependencies and to ensure that the right information is passed between various system components and systems.</q>

**We want to test how our system responds to user actions.**

---

## Testing real world apps?

.main-img[
![](../r/e2e-protractor/e2e-real-world-schema.svg)
]

---

## Testing real world apps!

- Unit tests
- Integration tests - hard
- E2E tests - huh

And ...
- User testing
- Validation (maybe?)

So ... do our E2E really cover everything? **Usually not.**

We fake, we simplify, we divide and conquer. 

---

## Testing frameworks

TDD = Test driven development
BDD = Behavior driven development [Given, When, Then]

Client-side test runners:
- Jasmin
- QUnit
- Mocha.js
- Cucumber [BDD]
- ....

---

## Testing frameworks ...

Test runners:
- Karma
- Intern
- Buster.js

E2E testing:
- Selenium WebDriver
- Nightswatch.js
- Protractor

---

## Testing frameworks ...

Distributed testing & continuous integration:
- TestSwarm, BrowserSwarm
- Selenium grid

Other:
- Sinon: spies, stubs & mocks
- yolpo: visualizing JS execution

---

# Protractor

angular.github.io/protractor

- E2E test framework for AngularJS applications
- build on top of selenium / WebDriverJS

Selenium? Basically browser automation. 

---

## Features

- runs tests against your application running in a real browser
- supports AngularJS specific interaction
- automatic waiting ($digest cycle)
- automatic promise handling
- debug console
- screenshots
- custom browser(s) with custom browser options or PhantomJS

---

## Supported JS testing frameworks

- Jasmine (default)
- Mocha
- Cucumber

## Supported browsers
- ChromeDriver
- FirefoxDriver
- SafariDriver
- IEDriver
- Appium - iOS/Safari, Android/Chrome
- Selendroid
- PhantomJS / GhostDriver

---

## Example configuration

```javascript
exports.config = {
    specs: ['scenarios.js'],
    chromeOnly: true,
    baseUrl: 'http://localhost:1234', 
    onPrepare: function () {
        // handle signin
        browser.ignoreSynchronization = true;
        browser.driver.get(localConfig.baseUrl + '/login');
        browser.driver.findElement(By.id('usr')).sendKeys('p@example.com');
        browser.driver.findElement(By.id('pass')).sendKeys('testtesttest');
        browser.driver.findElement(By.id('login)).click();
        return browser.driver.wait(function() {
            return browser.driver.getCurrentUrl().then(function(url) {
                return /application\/url/.test(url);
            });
        }, 10000);
    },
    framework: 'jasmine',
    jasmineNodeOpts: {
        isVerbose: true,
        showColors: true,
        includeStackTrace: true,
        defaultTimeoutInterval: 60000
    }
};
```

---

## Protractor w/ Jasmine

```javascript
describe('our-module', function() {
	beforeEach(function() { // setUp
		browser.get('index.html#/player');
	});

	it('more specific description', function () { // test_blah
		element(by.id('action-clear')).click(); // calling server!!
		expect(element(by.css('.queue-list li')).isPresent()).toBe(false);
		element(by.id('enqueue-url')).sendKeys("fJ9rUzIMcZQ");
		element(by.id('action-enqueue')).click();
	});
});

```

```javascript
...
element(by.css('.glyphicon-play')).click();
browser.wait(function () {
	return element(by.css('.glyphicon-stop')).isPresent();
}).then(function () {
	expect(
		element(by.css('.playing')).getText()
	).toContain('Bohemian Rhapsody');
}
...
```

---

## Angular specific

Again, Protractor waits for the $digest cycle to finish.
`browser.ignoreSynchronization = false;`



Also some useful angular locators: 
- `element(by.model('modelname'))`
- `element(by.binding('bindingname'))`
- `element.all(by.repeater('result in memory'))`


---

## Debugger console

With `browser.pause()`, we enter the debugger console.

Commands:
- `c` next command
- `repl` interactive REPL

Also, a debbuger available with `browser.debugger()`

---

## $provide - $delegate

Sometimes we just have to mock a service in our e2e pipeline.
If we want to do it on the frontend level, we can use $provide.

```javascript
app.config(['$provide', function ($provide) {
	$provide.decorator('serviceName', ['$delegate', function ($delegate) {

		$delegate.methodToMock1 = function () {
			// mock code
		};	

		$delegate.methodToMock2 = function () {
			// mock code
		};	

	}]);
}]);

```

---

# Issues & constraints

- *sometimes* hard to set up, error reporting usually not really useful
- timeouts do happen and they are not always straightforward to debug
- does not support $timeout -> use wait in tests or $interval in your Angular app
- browser.pause() and debugger repl are still beta

---

# Maybe Pingdom?

E2E are great, but how do we know if our production app really works?

Pingdom is a website monitoring service. Features:
- Uptime monitoring
- Real user monitoring
- Transaction monitoring
- Incident management
- API

---

## Transaction tests

Example: 

```http
Go to URL https://www.example.com
Fill in field #id_username with user@example.com
Fill in field #id_password with computersaysno
Submit form #signin_form
Element div[ng-app="example"] should exist
Wait for element div.row.body to exist
Element div.row.body should exist
Element li.profile should contain user@example.com
URL should be https://www.example.com/
```

---

### Pros
- tests production app 
- small but quite expressive transaction language

### Limitations
- max 25 transaction commands (but you can stack transactions =) )
- limited support for "complex" JS events (keyup, keydown)
- limited element selection
- cannot run custom JS code

---

# Our use case

We have an AngularJS frontend for our DSP content management platform.
For sales purposes we needed a demo that is only valid for one user session.
Demo's availability is crucial for successful sales pitches.

Testing:
- backend: unit and integration tests, monitoring
- app frontend: e2e with Protractor, services with Karma
- production: Pingdom transaction monitors

---

# Demo

.bigicon[
<i class="fa fa-play-circle"></i>
]

---

# Thank you

.bigicon[
<i class="fa fa-question-circle"></i>
]


    </textarea>
    <script src="../remark-latest.min.js">
    </script>
    <script>
		var slideshow = remark.create({
		slideNumberFormat: '%current% / %total%',
		});
    </script>
  </body>
</html>
